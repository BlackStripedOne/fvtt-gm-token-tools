const e={ID:"gm-token-tools",NAME:"Gamemaster Token Tools for DSA5",LCCNAME:"gmTokenTools"};class Logger$1{static info(t,a=!1){console.log(e.NAME+` Info | ${t}`),a&&ui.notifications.info(e.NAME+` | ${t}`)}static error(t,a=!1){console.error(e.NAME+` Error | ${t}`),a&&ui.notifications.error(e.NAME+` | ${t}`)}static debug(t,a){if(game.gmTokenTools?game.gmTokenTools.isDebug:Utils$1.getSetting("debug",!1)){if(!a)return void console.log(e.NAME+` Debug | ${t}`);const i=Utils$1.deepClone(a);console.log(e.NAME+` Debug | ${t}`,i)}}}class Utils$1{static collectOptions(e,t){let a,i,o={};for(let l in t.options){let s=t.options[l];switch(o[l]={},s.type){case"number":a=e.find("input#"+l+"[type=number]")?.val(),a=Math.min(Math.max(s.range.min,a),s.range.max),o[l].val=a;break;case"chooseOne":i=e.find("select#"+l+" option:selected"),o[l].val=i.val(),i.attr("data-modtext")&&(o[l].mod=Utils$1.i18n(i.attr("data-modtext")));break;case"boolean":i=e.find("input#"+l+"[type=checkbox]"),i.is(":checked")?(o[l].val=s.values.true.value,i.attr("data-modtext")&&(o[l].mod=Utils$1.i18n(i.attr("data-modtext")))):o[l].val=s.values.false.value}if(void 0!==s.format){const e=Handlebars.compile(s.format);o[l].val=e({value:o[l].val})}}return e.find("input#manual[type=number]")&&(a=e.find("input#manual[type=number]").val(),0!=a&&(o.manual={val:a,mod:Utils$1.i18n("damage.manualModifier.labelMod")+": "+a})),Logger$1.debug("Collected options from dialog",o),o}static isBitSet(e,t){return 0!=(e&1<<t)}static deepClone(e,t){return deepClone(e,t)}static getActor(e,t){let a=null;return t&&(a=canvas.tokens.placeables.find((e=>e.id===t))),a?a.actor:game.actors.get(e)}static getItem(e,t){return e.items.get(t)}static getToken(e){return canvas.tokens.placeables.find((t=>t.id===e))}static getControlledTokens(){return game.canvas.tokens.controlled}static getControlledToken(){return game.canvas.tokens.controlled[0]}static getUserByTokenId(e){let t,a=e.actor.ownership;return game.users.forEach((e=>{null!==e.character&&e.active&&a[e._id]>0&&(t=e)})),t}static getSetting(t,a=null){let i=a??null;try{i=game.settings.get(e.ID,t)}catch{console.log(e.NAME+` Debug | GameConfig '${t}' not found`)}return i}static async setSetting(t,a){game.settings.settings.get(`${e.ID}.${t}`)?(await game.settings.set(e.ID,t,a),Logger$1.debug(`GameConfig '${t}' set to '${a}'`)):Logger$1.debug(`GameConfig '${t}' not found`)}static getUserFlag(t){return game.user.getFlag(e.ID,t)}static async setUserFlag(t,a){await game.user.setFlag(e.ID,t,a)}static async unsetUserFlag(t){await game.user.unsetFlag(e.ID,t)}static i18n(e,t=null){let a=game.i18n.localize(e);return a==e?(null==t&&(a=e),a):a}static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}}class GmTokenTools$1 extends Application{async init(){this.updateSettings(),Logger$1.debug("Application Initialized")}updateSettings(){Logger$1.debug("Updating Settings..."),this.isDebug=Utils$1.getSetting("debug"),this.chatToTarget=Utils$1.getSetting("chatToTarget"),this.defaultAction=Utils$1.getSetting("defaultAction"),this.ctrlAction=Utils$1.getSetting("ctrlAction"),this.altAction=Utils$1.getSetting("altAction"),Logger$1.debug("Settings Updated")}}const t={damageTypes:{fall:{name:"damage.fall.name",description:"damage.fall.description",options:{hight:{label:"damage.fall.hight",unit:"gridUnits",type:"number",range:{min:1,max:20},defValue:1,format:"{{value}}d6[black]"},impact:{label:"damage.fall.ground",unit:"SP",type:"chooseOne",options:{softest:{name:"damage.fall.softest",value:"-4",modText:"damage.fall.softestMod"},softer:{name:"damage.fall.softer",value:"-3",modText:"damage.fall.softerMod"},soft:{name:"damage.fall.soft",value:"-2",modText:"damage.fall.softMod"},bitsoft:{name:"damage.fall.bitsoft",value:"-1",modText:"damage.fall.bitsoftMod"},normal:{name:"damage.fall.normal",value:"0"},bithard:{name:"damage.fall.bithard",value:"1",modText:"damage.fall.bithardMod"},hard:{name:"damage.fall.hard",value:"2",modText:"damage.fall.hardMod"},harder:{name:"damage.fall.harder",value:"3",modText:"damage.fall.harderMod"},hardest:{name:"damage.fall.hardest",value:"4",modText:"damage.fall.harderMod"}},defValue:"normal"}},formula:"(@hight + @impact) + @manual",manualModification:!0},burn:{name:"damage.burn.name",description:"damage.burn.description",options:{area:{label:"damage.burn.areaLabel",type:"chooseOne",defValue:"small",options:{small:{name:"damage.burn.areaSmall",value:"1d3"},medium:{name:"damage.burn.areaMedium",value:"1d6"},large:{name:"damage.burn.areaLarge",value:"2d6"}},format:"{{value}}[black]"},extreme:{label:"damage.burn.extremeLabel",unit:"damage.burn.extremeUnit",type:"boolean",values:{true:{value:2,modText:"damage.burn.extremeMod"},false:{value:1}}}},formula:"(@area * @extreme) + @manual",manualModification:!0}}};class DamageHandler{static async rollDamageForToken(e){let t=Utils$1.getToken(e);if(void 0===t)return;let a=await new Roll("1d6[black]").evaluate({async:!0});game.dice3d?.showForRoll(a),t.actor.applyDamage(a.total);let i=Handlebars.compile(Utils$1.i18n("actions.damageRoll.chatHb"))({name:t.actor.name,roll:a.total});ChatMessage.create({user:game.user._id,content:i})}static async doDamageRoll(t,a,i){Logger$1.debug("doDamageRoll",{token:t,damage:a,options:i});let o={};for(let e in i)o[e]=i[e].val;let l=new Roll(a.formula,o);await l.evaluate({async:!0}),game.dice3d?.showForRoll(l),t.actor.applyDamage(l.total);let s=[],n=l.total;for(let e in l.dice)for(let t=0;t<l.dice[e].number;t++)s.push({die:"d"+l.dice[e].faces,value:l.dice[e].results[t].result}),n-=l.dice[e].results[t].result;let r=[];for(let e in i)void 0!==i[e].mod&&r.push(i[e].mod);const g=await renderTemplate("modules/"+e.ID+"/templates/damageRollResultChat.hbs",{name:t.actor.name,roll:l.total,dice:s,damageType:a.name,modifier:n,modifiers:r});ChatMessage.create({user:game.user._id,content:g})}static async handleDamageRoll(a,i,o){if(Logger$1.debug("handleDamageRoll",{token:a,value:i,mod:o}),void 0===t.damageTypes[i])return;let l=t.damageTypes[i],s={damageHeader:Utils$1.i18n(l.name)+" Wurf fÃ¼r "+a.actor.name,damageDescription:l.description,options:[]};for(let e in l.options){let t=l.options[e];switch(t.type){case"number":s.options.push({type:"number",id:e,label:t.label,min:t.range.min,max:t.range.max,value:t.defValue,unit:t.unit});break;case"chooseOne":let a=[];for(let e in t.options){let i={};e==t.default&&(i.selected=!0),void 0!==t.options[e].modText&&(i.modText=t.options[e].modText),i.value=t.options[e].value,i.name=t.options[e].name,a.push(i)}s.options.push({type:"chooseOne",id:e,label:t.label,choices:a});break;case"boolean":let i={type:"boolean",id:e,label:t.label};void 0!==t.values.true.modText&&(i.modText=t.values.true.modText),s.options.push(i);break;default:Logger$1.debug("Invalid configuration",l)}}void 0!==l.manualModification&&l.manualModification&&s.options.push({type:"number",id:"manual",label:"damage.manualModifier.label",value:0}),Logger$1.debug("DamageRollDialog",s);const n=await renderTemplate("modules/"+e.ID+"/templates/damageRollDialog.hbs",s);new game.dsa5.apps.DSA5Dialog({title:"Schadensprobe auf "+Utils$1.i18n(l.name)+" anfordern",content:n,buttons:{ok:{label:"Ja",callback:e=>{DamageHandler.doDamageRoll(a,l,Utils$1.collectOptions(e,l))}},cancel:{label:"Abbrechen"}}},{width:700,resizable:!1}).render(!0)}}class SkillHandler{static requestRoll(e,t,a,i,o){const l=i<0?` ${i}`:i>0?` +${i}`:"",s=game.i18n.format("gmTokenTools.actions.requestRoll",{user:game.user.name,item:`<a class="roll-button request-roll" data-type="${t}" data-modifier="${i}" data-name="${a}"><i class="fas fa-dice"></i> ${a}${l}</a>`});let n={user:game.user._id,content:s};if("alwaysUser"==game.gmTokenTools.chatToTarget||"shiftEveryoneElseUser"==game.gmTokenTools.chatToTarget&&!o||"shiftUserElseEveryone"==game.gmTokenTools.chatToTarget&&o){let t=Utils$1.getUserByTokenId(e);if(void 0===t)return;mergeObject(n,{whisper:[t]})}ChatMessage.create(n)}async requestRollDialog(t,a,i,o){const l=game.i18n.format("gmTokenTools.actions.requestRollDialog.content",{skill:i}),s=await renderTemplate("modules/"+e.ID+"/templates/requestRollDialog.hbs",{text:l});new game.dsa5.apps.DSA5Dialog({title:Utils$1.i18n("actions.requestRollDialog.title"),content:s,buttons:{ok:{label:"Ja",callback:e=>{const l=e.find('input[name="entryselection"]').val();SkillHandler.requestRoll(t,a,i,l,o)}},cancel:{label:"Abbrechen"}}}).render(!0)}static async handleRoll(e,t,a,i){let o,l;"attribute"==t?(o=game.dsa5.apps.DSA5_Utility.attributeLocalization(a),l=a):"skill"==t&&(l=await game.dsa5.apps.DSA5_Utility.skillByName(a),o=a);let s="nothing";switch(s=Utils$1.isBitSet(i,0)?this.ctrlAction:Utils$1.isBitSet(i,1)?this.altAction:this.defaultAction,s){case"requestRoll":Logger$1.debug("Requesting roll",{token:e,type:t,id:o,skillAttrObj:l}),SkillHandler.requestRoll(e,t,o,0,Utils$1.isBitSet(i,2));break;case"requestRollDialog":Logger$1.debug("Requesting roll Dialog",{token:e,type:t,id:o,skillAttrObj:l}),SkillHandler.requestRollDialog(e,t,o,Utils$1.isBitSet(i,2));break;case"initiateRoll":Logger$1.debug("Initiae Roll",{token:e,type:t,id:o,skillAttrObj:l}),"skill"==t?e.actor.setupSkill(l,{},e._id).then((t=>{e.actor.basicTest(t)})):"attribute"==t&&e.actor.setupCharacteristic(l,{},e._id).then((t=>{e.actor.basicTest(t)}))}}}class GmTokenToolsApi$1{isDebug=!1;gmTokenTools=void 0;async init(){this.isDebug=Utils$1.getSetting("debug"),void 0===this.gmTokenTools&&(this.gmTokenTools=new GmTokenTools$1,this.gmTokenTools.init()),Logger$1.info("API Initialized")}updateSettings(){this.gmTokenTools?.updateSettings()}handleClick(e){let t=e.getAttribute("data-id"),a=e.parentElement.getAttribute("data-type"),i=e.parentElement.getAttribute("data-token"),o=Utils$1.getToken(i);if(void 0===o)return;let l=0;window.event.ctrlKey&&(l+=1),window.event.altKey&&(l+=2),window.event.shiftKey&&(l+=4),"attribute"==a||"skill"==a?SkillHandler.handleRoll(o,a,t,l):"damage"==a?DamageHandler.handleDamageRoll(o,t,l):Logger$1.debug("handleClick(): unknown how to handle parameters",{clickId:t,clickType:a,clickToken:i,modifier:l})}}class Hud$1{async addTokenActions(e,t,a){let i=canvas.tokens.get(a._id).actor;if(void 0===i)return;let o=[];for(let e of i.items)switch(e.type){case"adventage":case"disadventage":case"specialability":case"combatskill":break;case"skill":e.system.talentValue.value>0&&o.push({name:e.name,value:e.system.talentValue.value})}let l="",s="";o.sort(((e,t)=>t.value-e.value));for(let e of o)s+='<li onClick="game.gmTokenTools.handleClick(this);" data-id="'+e.name+'">('+e.value+") "+e.name+"</li>";l+='<div class="control-icon token-tool-icon" title="Roll Checks"><i class="fas fa-dice"></i> '+Utils$1.i18n("actions.skills.name")+'</div><div class="token-tool-list-wrapper"><ul class="token-tool-list" data-type="skill" data-token="'+a._id+'">'+s+"</ul></div>";let n="",r=["mu","kl","in","ch","ff","ge","ko","kk"];for(let e of r)n+='<li onClick="game.gmTokenTools.handleClick(this);" data-id="'+e+'">('+i.system.characteristics[e].value+") "+game.dsa5.apps.DSA5_Utility.attributeLocalization(e)+"</li>";l+='<div class="control-icon token-tool-icon" title="Roll Checks"><i class="fas fa-dice"></i> '+Utils$1.i18n("actions.attributes.name")+'</div><div class="token-tool-list-wrapper"><ul class="token-tool-list" data-type="attribute" data-token="'+a._id+'">'+n+"</ul></div>";let g="";g+="<li onClick=\"game.gmTokenTools.rollDamageForToken('"+a._id+"'); return false;\">1d6 Schaden</li>";for(let e in GTT.damageTypes)g+='<li onClick="game.gmTokenTools.handleClick(this);" data-id="'+e+'">'+Utils$1.i18n(GTT.damageTypes[e].name)+"</li>";switch(g+="<li onClick=\"game.dsa5.macro.requestRoll('Regeneration', 0);\">Regenerieren</li>",l+='<div class="control-icon token-tool-icon" title="Roll Checks"><i class="fas fa-dice"></i> Specials</div><div class="token-tool-list-wrapper"><ul class="token-tool-list" data-type="damage" data-token="'+a._id+'">'+g+"</ul></div>",l+='<div class="control-icon token-tool-icon token-tool-hint">',"nothing"!=this.defaultAction&&(l+='<i class="fas fa-solid fa-computer-mouse"></i> '+Utils$1.i18n("settings.actionChoices."+this.defaultAction)+"</br>"),"nothing"!=this.ctrlAction&&(l+='<i class="fas fa-solid fa-computer-mouse"></i>+<span class="key">Ctrl</span> '+Utils$1.i18n("settings.actionChoices."+this.ctrlAction)+"</br>"),"nothing"!=this.altAction&&(l+='<i class="fas fa-solid fa-computer-mouse"></i>+<span class="key">Alt</span> '+Utils$1.i18n("settings.actionChoices."+this.altAction)+"</br>"),this.chatToTarget){case"alwaysEveryone":case"alwaysUser":l+='<i class="fas fa-solid fa-comment"></i> '+Utils$1.i18n("settings.chatToTarget.choices."+this.chatToTarget)+"</br>";break;case"shiftEveryoneElseUser":case"shiftUserElseEveryone":l+='<i class="fas fa-solid fa-comment"></i> '+Utils$1.i18n("settings.chatToTarget.choices.alwaysUser")+', <span class="key">Shift</span> '+Utils$1.i18n("settings.chatToTarget.choices.shiftEveryoneElseUser")+"</br>"}l+="</div>";let c=$(`<div class="col token-tool-column-right">${l}</div>`);t.find(".col.right").wrap('<div class="token-tool-container">'),t.find(".col.right").before(c),Logger$1.debug("Actions injected to token HUD")}async addTokenInfos(e,t,a){let i=Utils$1.getActor(null,a._id);if(void 0===i)return;let o="",l=i.system.status.speed.max;o+='<div class="control-icon token-tool-icon" title="'+Utils$1.i18n("infos.speed.name")+": "+l+'"><i class="fas fa-walking"></i> '+l+"</div>";let s="-";s="creature"==i.type?"crt":"npc"==i.type?"npc":"character"==i.type?i.system.details.experience.total:"-",o+='<div class="control-icon token-tool-icon" title="'+Utils$1.i18n("infos.expTotal.name")+": "+s+'"><i class="fas fa-solid fa-scroll"></i> '+s+"</div>";o+='<div class="control-icon token-tool-icon" title="'+Utils$1.i18n("infos.acTotal.name")+': 0"><i class="fas fa-shield-alt"></i> 0</div>';let n=$(`<div class="col token-tool-column-left">${o}</div>`);t.find(".col.left").wrap('<div class="token-tool-container">'),t.find(".col.left").before(n),Logger$1.debug("Infos injected into token HUD")}}function onChangeFunction$1(t){game[e.LCCNAME]&&game[e.LCCNAME].updateSettings()}const registerSettings$1=function(){game.settings.register(e.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"debug",{name:Utils$1.i18n("settings.debug.name"),hint:Utils$1.i18n("settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{onChangeFunction$1()}}),game.settings.register(e.ID,"gmOnly",{name:Utils$1.i18n("settings.gmOnly.name"),hint:Utils$1.i18n("settings.gmOnly.hint"),scope:"world",config:!0,default:!0,type:Boolean,onChange:e=>{onChangeFunction$1()}}),game.settings.register(e.ID,"showCombatSkills",{name:Utils$1.i18n("settings.showCombatSkills.name"),hint:Utils$1.i18n("settings.showCombatSkills.hint"),scope:"world",config:!0,default:!1,type:Boolean,onChange:e=>{onChangeFunction$1()}}),game.settings.register(e.ID,"chatToTarget",{name:Utils$1.i18n("settings.chatToTarget.name"),hint:Utils$1.i18n("settings.chatToTarget.hint"),scope:"world",config:!0,type:String,default:"alwaysEveryone",choices:{alwaysEveryone:Utils$1.i18n("settings.chatToTarget.choices.alwaysEveryone"),alwaysUser:Utils$1.i18n("settings.chatToTarget.choices.alwaysUser"),shiftEveryoneElseUser:Utils$1.i18n("settings.chatToTarget.choices.shiftEveryoneElseUser"),shiftUserElseEveryone:Utils$1.i18n("settings.chatToTarget.choices.shiftUserElseEveryone")},onChange:e=>{onChangeFunction$1()}}),game.settings.register(e.ID,"defaultAction",{name:Utils$1.i18n("settings.defaultAction.name"),hint:Utils$1.i18n("settings.defaultAction.hint"),scope:"world",config:!0,type:String,default:"requestRoll",choices:{nothing:Utils$1.i18n("settings.actionChoices.nothing"),requestRoll:Utils$1.i18n("settings.actionChoices.requestRoll"),requestRollDialog:Utils$1.i18n("settings.actionChoices.requestRollDialog"),initiateRoll:Utils$1.i18n("settings.actionChoices.initiateRoll")},onChange:e=>{onChangeFunction$1()}}),game.settings.register(e.ID,"ctrlAction",{name:Utils$1.i18n("settings.ctrlAction.name"),hint:Utils$1.i18n("settings.ctrlAction.hint"),scope:"world",config:!0,type:String,default:"nothing",choices:{nothing:Utils$1.i18n("settings.actionChoices.nothing"),requestRoll:Utils$1.i18n("settings.actionChoices.requestRoll"),requestRollDialog:Utils$1.i18n("settings.actionChoices.requestRollDialog"),initiateRoll:Utils$1.i18n("settings.actionChoices.initiateRoll")},onChange:e=>{onChangeFunction$1()}}),game.settings.register(e.ID,"altAction",{name:Utils$1.i18n("settings.altAction.name"),hint:Utils$1.i18n("settings.altAction.hint"),scope:"world",config:!0,type:String,default:"nothing",choices:{nothing:Utils$1.i18n("settings.actionChoices.nothing"),requestRoll:Utils$1.i18n("settings.actionChoices.requestRoll"),requestRollDialog:Utils$1.i18n("settings.actionChoices.requestRollDialog"),initiateRoll:Utils$1.i18n("settings.actionChoices.initiateRoll")},onChange:e=>{onChangeFunction$1()}}),Logger$1.debug("Settings Registered")},a="gm-token-tools",i="Gamemaster Token Tools for DSA5",o="gmTokenTools";class Logger{static info(e,t=!1){console.log(i+` Info | ${e}`),t&&ui.notifications.info(i+` | ${e}`)}static error(e,t=!1){console.error(i+` Error | ${e}`),t&&ui.notifications.error(i+` | ${e}`)}static debug(e,t){if(game.gmTokenTools?game.gmTokenTools.isDebug:Utils.getSetting("debug",!1)){if(!t)return void console.log(i+` Debug | ${e}`);const a=Utils.deepClone(t);console.log(i+` Debug | ${e}`,a)}}}class Utils{static isBitSet(e,t){return 0!=(e&1<<t)}static deepClone(e,t){return deepClone(e,t)}static getActor(e,t){let a=null;return t&&(a=canvas.tokens.placeables.find((e=>e.id===t))),a?a.actor:game.actors.get(e)}static getItem(e,t){return e.items.get(t)}static getToken(e){return canvas.tokens.placeables.find((t=>t.id===e))}static getControlledTokens(){return game.canvas.tokens.controlled}static getControlledToken(){return game.canvas.tokens.controlled[0]}static getUserByTokenId(e){let t,a=e.actor.ownership;return game.users.forEach((e=>{null!==e.character&&e.active&&a[e._id]>0&&(t=e)})),t}static getSetting(e,t=null){let o=t??null;try{o=game.settings.get(a,e)}catch{console.log(i+` Debug | GameConfig '${e}' not found`)}return o}static async setSetting(e,t){game.settings.settings.get(`${a}.${e}`)?(await game.settings.set(a,e,t),Logger.debug(`GameConfig '${e}' set to '${t}'`)):Logger.debug(`GameConfig '${e}' not found`)}static getUserFlag(e){return game.user.getFlag(a,e)}static async setUserFlag(e,t){await game.user.setFlag(a,e,t)}static async unsetUserFlag(e){await game.user.unsetFlag(a,e)}static i18n(e,t=null){let a=game.i18n.localize(e);return a==e?(null==t&&(a=e),a):a}static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}}const l={damageTypes:{fall:{name:"damage.fall.name",description:"damage.fall.description",options:{hight:{label:"damage.fall.hight",unit:"gridUnits",type:"number",range:{min:1,max:20},defValue:1,format:"{{value}}d6[black]"},impact:{label:"damage.fall.ground",unit:"SP",type:"chooseOne",options:{softest:{name:"damage.fall.softest",value:"-4",modText:"damage.fall.softestMod"},softer:{name:"damage.fall.softer",value:"-3",modText:"damage.fall.softerMod"},soft:{name:"damage.fall.soft",value:"-2",modText:"damage.fall.softMod"},bitsoft:{name:"damage.fall.bitsoft",value:"-1",modText:"damage.fall.bitsoftMod"},normal:{name:"damage.fall.normal",value:"0"},bithard:{name:"damage.fall.bithard",value:"1",modText:"damage.fall.bithardMod"},hard:{name:"damage.fall.hard",value:"2",modText:"damage.fall.hardMod"},harder:{name:"damage.fall.harder",value:"3",modText:"damage.fall.harderMod"},hardest:{name:"damage.fall.hardest",value:"4",modText:"damage.fall.harderMod"}},defValue:"normal"}},formula:"(@hight + @impact) + @manual",manualModification:!0},burn:{name:"damage.burn.name",description:"damage.burn.description",options:{area:{label:"damage.burn.areaLabel",type:"chooseOne",defValue:"small",options:{small:{name:"damage.burn.areaSmall",value:"1d3"},medium:{name:"damage.burn.areaMedium",value:"1d6"},large:{name:"damage.burn.areaLarge",value:"2d6"}},format:"{{value}}[black]"},extreme:{label:"damage.burn.extremeLabel",unit:"damage.burn.extremeUnit",type:"boolean",values:{true:{value:2,modText:"damage.burn.extremeMod"},false:{value:1}}}},formula:"(@area * @extreme) + @manual",manualModification:!0}}};class Hud{async addTokenActions(e,t,a){let i=canvas.tokens.get(a._id).actor;if(void 0===i)return;let o=[];for(let e of i.items)switch(e.type){case"adventage":case"disadventage":case"specialability":case"combatskill":break;case"skill":e.system.talentValue.value>0&&o.push({name:e.name,value:e.system.talentValue.value})}let l="",s="";o.sort(((e,t)=>t.value-e.value));for(let e of o)s+='<li onClick="game.gmTokenTools.handleClick(this);" data-id="'+e.name+'">('+e.value+") "+e.name+"</li>";l+='<div class="control-icon token-tool-icon" title="Roll Checks"><i class="fas fa-dice"></i> '+Utils.i18n("actions.skills.name")+'</div><div class="token-tool-list-wrapper"><ul class="token-tool-list" data-type="skill" data-token="'+a._id+'">'+s+"</ul></div>";let n="",r=["mu","kl","in","ch","ff","ge","ko","kk"];for(let e of r)n+='<li onClick="game.gmTokenTools.handleClick(this);" data-id="'+e+'">('+i.system.characteristics[e].value+") "+game.dsa5.apps.DSA5_Utility.attributeLocalization(e)+"</li>";l+='<div class="control-icon token-tool-icon" title="Roll Checks"><i class="fas fa-dice"></i> '+Utils.i18n("actions.attributes.name")+'</div><div class="token-tool-list-wrapper"><ul class="token-tool-list" data-type="attribute" data-token="'+a._id+'">'+n+"</ul></div>";let g="";g+="<li onClick=\"game.gmTokenTools.rollDamageForToken('"+a._id+"'); return false;\">1d6 Schaden</li>";for(let e in GTT.damageTypes)g+='<li onClick="game.gmTokenTools.handleClick(this);" data-id="'+e+'">'+Utils.i18n(GTT.damageTypes[e].name)+"</li>";switch(g+="<li onClick=\"game.dsa5.macro.requestRoll('Regeneration', 0);\">Regenerieren</li>",l+='<div class="control-icon token-tool-icon" title="Roll Checks"><i class="fas fa-dice"></i> Specials</div><div class="token-tool-list-wrapper"><ul class="token-tool-list" data-type="damage" data-token="'+a._id+'">'+g+"</ul></div>",l+='<div class="control-icon token-tool-icon token-tool-hint">',"nothing"!=this.defaultAction&&(l+='<i class="fas fa-solid fa-computer-mouse"></i> '+Utils.i18n("settings.actionChoices."+this.defaultAction)+"</br>"),"nothing"!=this.ctrlAction&&(l+='<i class="fas fa-solid fa-computer-mouse"></i>+<span class="key">Ctrl</span> '+Utils.i18n("settings.actionChoices."+this.ctrlAction)+"</br>"),"nothing"!=this.altAction&&(l+='<i class="fas fa-solid fa-computer-mouse"></i>+<span class="key">Alt</span> '+Utils.i18n("settings.actionChoices."+this.altAction)+"</br>"),this.chatToTarget){case"alwaysEveryone":case"alwaysUser":l+='<i class="fas fa-solid fa-comment"></i> '+Utils.i18n("settings.chatToTarget.choices."+this.chatToTarget)+"</br>";break;case"shiftEveryoneElseUser":case"shiftUserElseEveryone":l+='<i class="fas fa-solid fa-comment"></i> '+Utils.i18n("settings.chatToTarget.choices.alwaysUser")+', <span class="key">Shift</span> '+Utils.i18n("settings.chatToTarget.choices.shiftEveryoneElseUser")+"</br>"}l+="</div>";let c=$(`<div class="col token-tool-column-right">${l}</div>`);t.find(".col.right").wrap('<div class="token-tool-container">'),t.find(".col.right").before(c),Logger.debug("Actions injected to token HUD")}async addTokenInfos(e,t,a){let i=Utils.getActor(null,a._id);if(void 0===i)return;let o="",l=i.system.status.speed.max;o+='<div class="control-icon token-tool-icon" title="'+Utils.i18n("infos.speed.name")+": "+l+'"><i class="fas fa-walking"></i> '+l+"</div>";let s="-";s="creature"==i.type?"crt":"npc"==i.type?"npc":"character"==i.type?i.system.details.experience.total:"-",o+='<div class="control-icon token-tool-icon" title="'+Utils.i18n("infos.expTotal.name")+": "+s+'"><i class="fas fa-solid fa-scroll"></i> '+s+"</div>",o+='<div class="control-icon token-tool-icon" title="'+Utils.i18n("infos.acTotal.name")+': 0"><i class="fas fa-shield-alt"></i> 0</div>';let n=$(`<div class="col token-tool-column-left">${o}</div>`);t.find(".col.left").wrap('<div class="token-tool-container">'),t.find(".col.left").before(n),Logger.debug("Infos injected into token HUD")}}class GmTokenTools extends Application{async init(){this.updateSettings(),Logger.debug("Application Initialized")}updateSettings(){Logger.debug("Updating Settings..."),this.isDebug=Utils.getSetting("debug"),this.chatToTarget=Utils.getSetting("chatToTarget"),this.defaultAction=Utils.getSetting("defaultAction"),this.ctrlAction=Utils.getSetting("ctrlAction"),this.altAction=Utils.getSetting("altAction"),Logger.debug("Settings Updated")}async rollDamageForToken(e){let t=Utils.getToken(e);if(void 0===t)return;let a=await new Roll("1d6[black]").evaluate({async:!0});game.dice3d?.showForRoll(a),t.actor.applyDamage(a.total);let i=Handlebars.compile(Utils.i18n("actions.damageRoll.chatHb"))({name:t.actor.name,roll:a.total});ChatMessage.create({user:game.user._id,content:i})}requestRoll(e,t,a,i,o){const l=i<0?` ${i}`:i>0?` +${i}`:"",s=game.i18n.format("gmTokenTools.actions.requestRoll",{user:game.user.name,item:`<a class="roll-button request-roll" data-type="${t}" data-modifier="${i}" data-name="${a}"><i class="fas fa-dice"></i> ${a}${l}</a>`});let n={user:game.user._id,content:s};if("alwaysUser"==this.chatToTarget||"shiftEveryoneElseUser"==this.chatToTarget&&!o||"shiftUserElseEveryone"==this.chatToTarget&&o){let t=Utils.getUserByTokenId(e);if(void 0===t)return;mergeObject(n,{whisper:[t]})}ChatMessage.create(n)}async handleRoll(e,t,a,i){let o,l;"attribute"==t?(o=game.dsa5.apps.DSA5_Utility.attributeLocalization(a),l=a):"skill"==t&&(l=await game.dsa5.apps.DSA5_Utility.skillByName(a),o=a);let s="nothing";switch(s=Utils.isBitSet(i,0)?this.ctrlAction:Utils.isBitSet(i,1)?this.altAction:this.defaultAction,s){case"requestRoll":Logger.debug("Requesting roll",{token:e,type:t,id:o,skillAttrObj:l}),this.requestRoll(e,t,o,0,Utils.isBitSet(i,2));break;case"requestRollDialog":Logger.debug("Requesting roll Dialog",{token:e,type:t,id:o,skillAttrObj:l}),this.requestRollDialog(e,t,o,Utils.isBitSet(i,2));break;case"initiateRoll":Logger.debug("Initiae Roll",{token:e,type:t,id:o,skillAttrObj:l}),"skill"==t?e.actor.setupSkill(l,{},e._id).then((t=>{e.actor.basicTest(t)})):"attribute"==t&&e.actor.setupCharacteristic(l,{},e._id).then((t=>{e.actor.basicTest(t)}))}}async doDamageRoll(e,t,i){Logger.debug("doDamageRoll",{token:e,damage:t,options:i});let o={};for(let e in i)o[e]=i[e].val;let l=new Roll(t.formula,o);await l.evaluate({async:!0}),game.dice3d?.showForRoll(l),e.actor.applyDamage(l.total);let s=[],n=l.total;for(let e in l.dice)for(let t=0;t<l.dice[e].number;t++)s.push({die:"d"+l.dice[e].faces,value:l.dice[e].results[t].result}),n-=l.dice[e].results[t].result;let r=[];for(let e in i)void 0!==i[e].mod&&r.push(i[e].mod);const g=await renderTemplate("modules/"+a+"/templates/damageRollResultChat.hbs",{name:e.actor.name,roll:l.total,dice:s,damageType:t.name,modifier:n,modifiers:r});ChatMessage.create({user:game.user._id,content:g})}async handleDamageRoll(e,t,i){if(Logger.debug("handleDamageRoll",{token:e,value:t,mod:i}),void 0===l.damageTypes[t])return;let o=l.damageTypes[t],s={damageHeader:Utils.i18n(o.name)+" Wurf fÃ¼r "+e.actor.name,damageDescription:o.description,options:[]};for(let e in o.options){let t=o.options[e];switch(t.type){case"number":s.options.push({type:"number",id:e,label:t.label,min:t.range.min,max:t.range.max,value:t.defValue,unit:t.unit});break;case"chooseOne":let a=[];for(let e in t.options){let i={};e==t.default&&(i.selected=!0),void 0!==t.options[e].modText&&(i.modText=t.options[e].modText),i.value=t.options[e].value,i.name=t.options[e].name,a.push(i)}s.options.push({type:"chooseOne",id:e,label:t.label,choices:a});break;case"boolean":let i={type:"boolean",id:e,label:t.label};void 0!==t.values.true.modText&&(i.modText=t.values.true.modText),s.options.push(i);break;default:Logger.debug("Invalid configuration",o)}}void 0!==o.manualModification&&o.manualModification&&s.options.push({type:"number",id:"manual",label:"damage.manualModifier.label",value:0}),Logger.debug("DamageRollDialog",s);const n=await renderTemplate("modules/"+a+"/templates/damageRollDialog.hbs",s);new game.dsa5.apps.DSA5Dialog({title:"Schadensprobe auf "+Utils.i18n(o.name)+" anfordern",content:n,buttons:{ok:{label:"Ja",callback:t=>{this.doDamageRoll(e,o,this._collectOptions(t,o))}},cancel:{label:"Abbrechen"}}},{width:700,resizable:!1}).render(!0)}}class GmTokenToolsApi{isDebug=!1;gmTokenTools=void 0;async init(){this.isDebug=Utils.getSetting("debug"),void 0===this.gmTokenTools&&(this.gmTokenTools=new GmTokenTools,this.gmTokenTools.init()),Logger.info("API Initialized")}updateSettings(){this.gmTokenTools?.updateSettings()}handleClick(e){let t=e.getAttribute("data-id"),a=e.parentElement.getAttribute("data-type"),i=e.parentElement.getAttribute("data-token"),o=Utils.getToken(i);if(void 0===o)return;let l=0;window.event.ctrlKey&&(l+=1),window.event.altKey&&(l+=2),window.event.shiftKey&&(l+=4),"attribute"==a||"skill"==a?this.gmTokenTools?.handleRoll(o,a,t,l):"damage"==a?this.gmTokenTools?.handleDamageRoll(o,t,l):Logger.debug("handleClick(): unknown how to handle parameters",{clickId:t,clickType:a,clickToken:i,modifier:l})}}function onChangeFunction(e){game[o]&&game[o].updateSettings()}Hooks.on("ready",(async()=>{Hooks.callAll(o+"Initialized"),Logger.info("Ready")})),Hooks.once("init",(()=>{game.settings.register(a,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(a,"debug",{name:Utils.i18n("settings.debug.name"),hint:Utils.i18n("settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{onChangeFunction()}}),game.settings.register(a,"gmOnly",{name:Utils.i18n("settings.gmOnly.name"),hint:Utils.i18n("settings.gmOnly.hint"),scope:"world",config:!0,default:!0,type:Boolean,onChange:e=>{onChangeFunction()}}),game.settings.register(a,"showCombatSkills",{name:Utils.i18n("settings.showCombatSkills.name"),hint:Utils.i18n("settings.showCombatSkills.hint"),scope:"world",config:!0,default:!1,type:Boolean,onChange:e=>{onChangeFunction()}}),game.settings.register(a,"chatToTarget",{name:Utils.i18n("settings.chatToTarget.name"),hint:Utils.i18n("settings.chatToTarget.hint"),scope:"world",config:!0,type:String,default:"alwaysEveryone",choices:{alwaysEveryone:Utils.i18n("settings.chatToTarget.choices.alwaysEveryone"),alwaysUser:Utils.i18n("settings.chatToTarget.choices.alwaysUser"),shiftEveryoneElseUser:Utils.i18n("settings.chatToTarget.choices.shiftEveryoneElseUser"),shiftUserElseEveryone:Utils.i18n("settings.chatToTarget.choices.shiftUserElseEveryone")},onChange:e=>{onChangeFunction()}}),game.settings.register(a,"defaultAction",{name:Utils.i18n("settings.defaultAction.name"),hint:Utils.i18n("settings.defaultAction.hint"),scope:"world",config:!0,type:String,default:"requestRoll",choices:{nothing:Utils.i18n("settings.actionChoices.nothing"),requestRoll:Utils.i18n("settings.actionChoices.requestRoll"),requestRollDialog:Utils.i18n("settings.actionChoices.requestRollDialog"),initiateRoll:Utils.i18n("settings.actionChoices.initiateRoll")},onChange:e=>{onChangeFunction()}}),game.settings.register(a,"ctrlAction",{name:Utils.i18n("settings.ctrlAction.name"),hint:Utils.i18n("settings.ctrlAction.hint"),scope:"world",config:!0,type:String,default:"nothing",choices:{nothing:Utils.i18n("settings.actionChoices.nothing"),requestRoll:Utils.i18n("settings.actionChoices.requestRoll"),requestRollDialog:Utils.i18n("settings.actionChoices.requestRollDialog"),initiateRoll:Utils.i18n("settings.actionChoices.initiateRoll")},onChange:e=>{onChangeFunction()}}),game.settings.register(a,"altAction",{name:Utils.i18n("settings.altAction.name"),hint:Utils.i18n("settings.altAction.hint"),scope:"world",config:!0,type:String,default:"nothing",choices:{nothing:Utils.i18n("settings.actionChoices.nothing"),requestRoll:Utils.i18n("settings.actionChoices.requestRoll"),requestRollDialog:Utils.i18n("settings.actionChoices.requestRollDialog"),initiateRoll:Utils.i18n("settings.actionChoices.initiateRoll")},onChange:e=>{onChangeFunction()}}),Logger.debug("Settings Registered"),Logger.debug("Init Done")})),Hooks.on("canvasReady",(async()=>{Hooks.on(o+"Initialized",(async()=>{const e=Utils.getSetting("gmOnly");game.gmTokenTools||(game.gmTokenTools=new GmTokenToolsApi,await game.gmTokenTools.init(),Logger.debug("gmTokenTools API registered as game.gmTokenTools")),game.user.isGM?Hooks.on("renderTokenHUD",((e,t,a)=>{game.gmTokenTools.gmTokenTools.addTokenInfos(e,t,a),game.gmTokenTools.gmTokenTools.addTokenActions(e,t,a)})):e||Hooks.on("renderTokenHUD",((e,t,a)=>{game.gmTokenTools.gmTokenTools.addTokenInfos(e,t,a)})),Hooks.on("updateToken",((e,t,a)=>{Object.hasOwn(a,"y")||Object.hasOwn("diff","x")||Logger.debug(updateToken)}))}))})),Hooks.on("ready",(async()=>{Hooks.callAll(e.LCCNAME+"Initialized"),Logger$1.info("Ready")})),Hooks.once("init",(()=>{registerSettings$1(),Logger$1.debug("Init Done")})),Hooks.on("canvasReady",(async()=>{Hooks.on(e.LCCNAME+"Initialized",(async()=>{const e=Utils$1.getSetting("gmOnly");game.gmTokenTools||(game.gmTokenTools=new GmTokenToolsApi$1,await game.gmTokenTools.init(),Logger$1.debug("gmTokenTools API registered as game.gmTokenTools")),game.user.isGM?Hooks.on("renderTokenHUD",((e,t,a)=>{Hud.gmTokenTools.addTokenInfos(e,t,a),Hud.gmTokenTools.addTokenActions(e,t,a)})):e||Hooks.on("renderTokenHUD",((e,t,a)=>{Hud.gmTokenTools.addTokenInfos(e,t,a)})),Hooks.on("updateToken",((e,t,a)=>{Object.hasOwn(a,"y")||Object.hasOwn("diff","x")||Logger$1.debug(updateToken)}))}))}));export{DamageHandler,GmTokenTools$1 as GmTokenTools,GmTokenToolsApi$1 as GmTokenToolsApi,Hud$1 as Hud,Logger$1 as Logger,e as MODULE,SkillHandler,Utils$1 as Utils,registerSettings$1 as registerSettings};
