const e={ID:"gm-token-tools",NAME:"Gamemaster Token Tools for DSA5",LCCNAME:"gmTokenTools"};class Logger{static info(t,a=!1){console.log(e.NAME+` Info | ${t}`),a&&ui.notifications.info(e.NAME+` | ${t}`)}static error(t,a=!1){console.error(e.NAME+` Error | ${t}`),a&&ui.notifications.error(e.NAME+` | ${t}`)}static debug(t,a){if(game.gmTokenTools?game.gmTokenTools.isDebug:Utils.getSetting("debug",!1)){if(!a)return void console.log(e.NAME+` Debug | ${t}`);const o=Utils.deepClone(a);console.log(e.NAME+` Debug | ${t}`,o)}}}class Utils{static isBitSet(e,t){return 0!=(e&1<<t)}static deepClone(e,t){return deepClone(e,t)}static getActor(e,t){let a=null;return t&&(a=canvas.tokens.placeables.find((e=>e.id===t))),a?a.actor:game.actors.get(e)}static getItem(e,t){return e.items.get(t)}static getToken(e){return canvas.tokens.placeables.find((t=>t.id===e))}static getControlledTokens(){return game.canvas.tokens.controlled}static getControlledToken(){return game.canvas.tokens.controlled[0]}static getUserByTokenId(e){let t,a=e.actor.ownership;return game.users.forEach((e=>{null!==e.character&&e.active&&a[e._id]>0&&(t=e)})),t}static getSetting(t,a=null){let o=a??null;try{o=game.settings.get(e.ID,t)}catch{console.log(e.NAME+` Debug | GameConfig '${t}' not found`)}return o}static async setSetting(t,a){game.settings.settings.get(`${e.ID}.${t}`)?(await game.settings.set(e.ID,t,a),Logger.debug(`GameConfig '${t}' set to '${a}'`)):Logger.debug(`GameConfig '${t}' not found`)}static getUserFlag(t){return game.user.getFlag(e.ID,t)}static async setUserFlag(t,a){await game.user.setFlag(e.ID,t,a)}static async unsetUserFlag(t){await game.user.unsetFlag(e.ID,t)}static i18n(e,t=null){let a=game.i18n.localize(e);return a==e?(null==t&&(a=e),a):a}static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}}const t={damageTypes:{fall:{name:"damage.fall.name",description:"damage.fall.description",options:{hight:{label:"damage.fall.hight",unit:"gridUnits",type:"number",range:{min:1,max:20},defValue:1,format:"{{value}}d6[black]"},impact:{label:"damage.fall.ground",unit:"SP",type:"chooseOne",options:{softest:{name:"damage.fall.softest",value:"-4",modText:"damage.fall.softestMod"},softer:{name:"damage.fall.softer",value:"-3",modText:"damage.fall.softerMod"},soft:{name:"damage.fall.soft",value:"-2",modText:"damage.fall.softMod"},bitsoft:{name:"damage.fall.bitsoft",value:"-1",modText:"damage.fall.bitsoftMod"},normal:{name:"damage.fall.normal",value:"0"},bithard:{name:"damage.fall.bithard",value:"1",modText:"damage.fall.bithardMod"},hard:{name:"damage.fall.hard",value:"2",modText:"damage.fall.hardMod"},harder:{name:"damage.fall.harder",value:"3",modText:"damage.fall.harderMod"},hardest:{name:"damage.fall.hardest",value:"4",modText:"damage.fall.harderMod"}},defValue:"normal"}},formula:"(@hight + @impact) + @manual",manualModification:!0},burn:{name:"damage.burn.name",description:"damage.burn.description",options:{area:{label:"damage.burn.areaLabel",type:"chooseOne",defValue:"small",options:{small:{name:"damage.burn.areaSmall",value:"1d3"},medium:{name:"damage.burn.areaMedium",value:"1d6"},large:{name:"damage.burn.areaLarge",value:"2d6"}},format:"{{value}}[black]"},extreme:{label:"damage.burn.extremeLabel",unit:"damage.burn.extremeUnit",type:"boolean",values:{true:{value:2,modText:"damage.burn.extremeMod"},false:{value:1}}}},formula:"(@area * @extreme) + @manual",manualModification:!0}}};class GmTokenTools extends Application{async init(){this.updateSettings(),Logger.debug("Application Initialized")}updateSettings(){Logger.debug("Updating Settings..."),this.isDebug=Utils.getSetting("debug"),this.chatToTarget=Utils.getSetting("chatToTarget"),this.defaultAction=Utils.getSetting("defaultAction"),this.ctrlAction=Utils.getSetting("ctrlAction"),this.altAction=Utils.getSetting("altAction"),Logger.debug("Settings Updated")}async rollDamageForToken(e){let t=Utils.getToken(e);if(void 0===t)return;let a=await new Roll("1d6[black]").evaluate({async:!0});game.dice3d?.showForRoll(a),t.actor.applyDamage(a.total);let o=Handlebars.compile(Utils.i18n("actions.damageRoll.chatHb"))({name:t.actor.name,roll:a.total});ChatMessage.create({user:game.user._id,content:o})}requestRoll(e,t,a,o,i){const l=o<0?` ${o}`:o>0?` +${o}`:"",n=game.i18n.format("gmTokenTools.actions.requestRoll",{user:game.user.name,item:`<a class="roll-button request-roll" data-type="${t}" data-modifier="${o}" data-name="${a}"><i class="fas fa-dice"></i> ${a}${l}</a>`});let s={user:game.user._id,content:n};if("alwaysUser"==this.chatToTarget||"shiftEveryoneElseUser"==this.chatToTarget&&!i||"shiftUserElseEveryone"==this.chatToTarget&&i){let t=Utils.getUserByTokenId(e);if(void 0===t)return;mergeObject(s,{whisper:[t]})}ChatMessage.create(s)}async requestRollDialog(t,a,o,i){const l=game.i18n.format("gmTokenTools.actions.requestRollDialog.content",{skill:o}),n=await renderTemplate("modules/"+e.ID+"/templates/requestRollDialog.hbs",{text:l});new game.dsa5.apps.DSA5Dialog({title:Utils.i18n("actions.requestRollDialog.title"),content:n,buttons:{ok:{label:"Ja",callback:e=>{const l=e.find('input[name="entryselection"]').val();this.requestRoll(t,a,o,l,i)}},cancel:{label:"Abbrechen"}}}).render(!0)}async handleRoll(e,t,a,o){let i,l;"attribute"==t?(i=game.dsa5.apps.DSA5_Utility.attributeLocalization(a),l=a):"skill"==t&&(l=await game.dsa5.apps.DSA5_Utility.skillByName(a),i=a);let n="nothing";switch(n=Utils.isBitSet(o,0)?this.ctrlAction:Utils.isBitSet(o,1)?this.altAction:this.defaultAction,n){case"requestRoll":Logger.debug("Requesting roll",{token:e,type:t,id:i,skillAttrObj:l}),this.requestRoll(e,t,i,0,Utils.isBitSet(o,2));break;case"requestRollDialog":Logger.debug("Requesting roll Dialog",{token:e,type:t,id:i,skillAttrObj:l}),this.requestRollDialog(e,t,i,Utils.isBitSet(o,2));break;case"initiateRoll":Logger.debug("Initiae Roll",{token:e,type:t,id:i,skillAttrObj:l}),"skill"==t?e.actor.setupSkill(l,{},e._id).then((t=>{e.actor.basicTest(t)})):"attribute"==t&&e.actor.setupCharacteristic(l,{},e._id).then((t=>{e.actor.basicTest(t)}))}}async doDamageRoll(t,a,o){Logger.debug("doDamageRoll",{token:t,damage:a,options:o});let i={};for(let e in o)i[e]=o[e].val;let l=new Roll(a.formula,i);await l.evaluate({async:!0}),game.dice3d?.showForRoll(l),t.actor.applyDamage(l.total);let n=[],s=l.total;for(let e in l.dice)for(let t=0;t<l.dice[e].number;t++)n.push({die:"d"+l.dice[e].faces,value:l.dice[e].results[t].result}),s-=l.dice[e].results[t].result;let r=[];for(let e in o)void 0!==o[e].mod&&r.push(o[e].mod);const c=await renderTemplate("modules/"+e.ID+"/templates/damageRollResultChat.hbs",{name:t.actor.name,roll:l.total,dice:n,damageType:a.name,modifier:s,modifiers:r});ChatMessage.create({user:game.user._id,content:c})}_collectOptions(e,t){let a,o,i={};for(let l in t.options){let n=t.options[l];switch(i[l]={},n.type){case"number":a=e.find("input#"+l+"[type=number]")?.val(),a=Math.min(Math.max(n.range.min,a),n.range.max),i[l].val=a;break;case"chooseOne":o=e.find("select#"+l+" option:selected"),i[l].val=o.val(),o.attr("data-modtext")&&(i[l].mod=Utils.i18n(o.attr("data-modtext")));break;case"boolean":o=e.find("input#"+l+"[type=checkbox]"),o.is(":checked")?(i[l].val=n.values.true.value,o.attr("data-modtext")&&(i[l].mod=Utils.i18n(o.attr("data-modtext")))):i[l].val=n.values.false.value}if(void 0!==n.format){const e=Handlebars.compile(n.format);i[l].val=e({value:i[l].val})}}return e.find("input#manual[type=number]")&&(a=e.find("input#manual[type=number]").val(),0!=a&&(i.manual={val:a,mod:Utils.i18n("damage.manualModifier.labelMod")+": "+a})),Logger.debug("Collected options from dialog",i),i}async handleDamageRoll(a,o,i){if(Logger.debug("handleDamageRoll",{token:a,value:o,mod:i}),void 0===t.damageTypes[o])return;let l=t.damageTypes[o],n={damageHeader:Utils.i18n(l.name)+" Wurf fÃ¼r "+a.actor.name,damageDescription:l.description,options:[]};for(let e in l.options){let t=l.options[e];switch(t.type){case"number":n.options.push({type:"number",id:e,label:t.label,min:t.range.min,max:t.range.max,value:t.defValue,unit:t.unit});break;case"chooseOne":let a=[];for(let e in t.options){let o={};e==t.default&&(o.selected=!0),void 0!==t.options[e].modText&&(o.modText=t.options[e].modText),o.value=t.options[e].value,o.name=t.options[e].name,a.push(o)}n.options.push({type:"chooseOne",id:e,label:t.label,choices:a});break;case"boolean":let o={type:"boolean",id:e,label:t.label};void 0!==t.values.true.modText&&(o.modText=t.values.true.modText),n.options.push(o);break;default:Logger.debug("Invalid configuration",l)}}void 0!==l.manualModification&&l.manualModification&&n.options.push({type:"number",id:"manual",label:"damage.manualModifier.label",value:0}),Logger.debug("DamageRollDialog",n);const s=await renderTemplate("modules/"+e.ID+"/templates/damageRollDialog.hbs",n);new game.dsa5.apps.DSA5Dialog({title:"Schadensprobe auf "+Utils.i18n(l.name)+" anfordern",content:s,buttons:{ok:{label:"Ja",callback:e=>{this.doDamageRoll(a,l,this._collectOptions(e,l))}},cancel:{label:"Abbrechen"}}},{width:700,resizable:!1}).render(!0)}async addTokenActions(e,a,o){let i=canvas.tokens.get(o._id).actor;if(void 0===i)return;let l=[];for(let e of i.items)switch(e.type){case"adventage":case"disadventage":case"specialability":case"combatskill":break;case"skill":e.system.talentValue.value>0&&l.push({name:e.name,value:e.system.talentValue.value})}let n="",s="";l.sort(((e,t)=>t.value-e.value));for(let e of l)s+='<li onClick="game.gmTokenTools.handleClick(this);" data-id="'+e.name+'">('+e.value+") "+e.name+"</li>";n+='<div class="control-icon token-tool-icon" title="Roll Checks"><i class="fas fa-dice"></i> '+Utils.i18n("actions.skills.name")+'</div><div class="token-tool-list-wrapper"><ul class="token-tool-list" data-type="skill" data-token="'+o._id+'">'+s+"</ul></div>";let r="",c=["mu","kl","in","ch","ff","ge","ko","kk"];for(let e of c)r+='<li onClick="game.gmTokenTools.handleClick(this);" data-id="'+e+'">('+i.system.characteristics[e].value+") "+game.dsa5.apps.DSA5_Utility.attributeLocalization(e)+"</li>";n+='<div class="control-icon token-tool-icon" title="Roll Checks"><i class="fas fa-dice"></i> '+Utils.i18n("actions.attributes.name")+'</div><div class="token-tool-list-wrapper"><ul class="token-tool-list" data-type="attribute" data-token="'+o._id+'">'+r+"</ul></div>";let g="";g+="<li onClick=\"game.gmTokenTools.rollDamageForToken('"+o._id+"'); return false;\">1d6 Schaden</li>";for(let e in t.damageTypes)g+='<li onClick="game.gmTokenTools.handleClick(this);" data-id="'+e+'">'+Utils.i18n(t.damageTypes[e].name)+"</li>";switch(g+="<li onClick=\"game.dsa5.macro.requestRoll('Regeneration', 0);\">Regenerieren</li>",n+='<div class="control-icon token-tool-icon" title="Roll Checks"><i class="fas fa-dice"></i> Specials</div><div class="token-tool-list-wrapper"><ul class="token-tool-list" data-type="damage" data-token="'+o._id+'">'+g+"</ul></div>",n+='<div class="control-icon token-tool-icon token-tool-hint">',"nothing"!=this.defaultAction&&(n+='<i class="fas fa-solid fa-computer-mouse"></i> '+Utils.i18n("settings.actionChoices."+this.defaultAction)+"</br>"),"nothing"!=this.ctrlAction&&(n+='<i class="fas fa-solid fa-computer-mouse"></i>+<span class="key">Ctrl</span> '+Utils.i18n("settings.actionChoices."+this.ctrlAction)+"</br>"),"nothing"!=this.altAction&&(n+='<i class="fas fa-solid fa-computer-mouse"></i>+<span class="key">Alt</span> '+Utils.i18n("settings.actionChoices."+this.altAction)+"</br>"),this.chatToTarget){case"alwaysEveryone":case"alwaysUser":n+='<i class="fas fa-solid fa-comment"></i> '+Utils.i18n("settings.chatToTarget.choices."+this.chatToTarget)+"</br>";break;case"shiftEveryoneElseUser":case"shiftUserElseEveryone":n+='<i class="fas fa-solid fa-comment"></i> '+Utils.i18n("settings.chatToTarget.choices.alwaysUser")+', <span class="key">Shift</span> '+Utils.i18n("settings.chatToTarget.choices.shiftEveryoneElseUser")+"</br>"}n+="</div>";let d=$(`<div class="col token-tool-column-right">${n}</div>`);a.find(".col.right").wrap('<div class="token-tool-container">'),a.find(".col.right").before(d),Logger.debug("Actions injected to token HUD")}async addTokenInfos(e,t,a){let o=Utils.getActor(null,a._id);if(void 0===o)return;let i="",l=o.system.status.speed.max;i+='<div class="control-icon token-tool-icon" title="'+Utils.i18n("infos.speed.name")+": "+l+'"><i class="fas fa-walking"></i> '+l+"</div>";let n="-";n="creature"==o.type?"crt":"npc"==o.type?"npc":"character"==o.type?o.system.details.experience.total:"-",i+='<div class="control-icon token-tool-icon" title="'+Utils.i18n("infos.expTotal.name")+": "+n+'"><i class="fas fa-solid fa-scroll"></i> '+n+"</div>";i+='<div class="control-icon token-tool-icon" title="'+Utils.i18n("infos.acTotal.name")+': 0"><i class="fas fa-shield-alt"></i> 0</div>';let s=$(`<div class="col token-tool-column-left">${i}</div>`);t.find(".col.left").wrap('<div class="token-tool-container">'),t.find(".col.left").before(s),Logger.debug("Infos injected into token HUD")}}class GmTokenToolsApi{isDebug=!1;gmTokenTools=void 0;async init(){this.isDebug=Utils.getSetting("debug"),void 0===this.gmTokenTools&&(this.gmTokenTools=new GmTokenTools,this.gmTokenTools.init()),Logger.info("API Initialized")}updateSettings(){this.gmTokenTools?.updateSettings()}handleClick(e){let t=e.getAttribute("data-id"),a=e.parentElement.getAttribute("data-type"),o=e.parentElement.getAttribute("data-token"),i=Utils.getToken(o);if(void 0===i)return;let l=0;window.event.ctrlKey&&(l+=1),window.event.altKey&&(l+=2),window.event.shiftKey&&(l+=4),"attribute"==a||"skill"==a?this.gmTokenTools?.handleRoll(i,a,t,l):"damage"==a?this.gmTokenTools?.handleDamageRoll(i,t,l):Logger.debug("handleClick(): unknown how to handle parameters",{clickId:t,clickType:a,clickToken:o,modifier:l})}}function onChangeFunction(t){game[e.LCCNAME]&&game[e.LCCNAME].updateSettings()}const registerSettings=function(){game.settings.register(e.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"debug",{name:Utils.i18n("settings.debug.name"),hint:Utils.i18n("settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"gmOnly",{name:Utils.i18n("settings.gmOnly.name"),hint:Utils.i18n("settings.gmOnly.hint"),scope:"world",config:!0,default:!0,type:Boolean,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"showCombatSkills",{name:Utils.i18n("settings.showCombatSkills.name"),hint:Utils.i18n("settings.showCombatSkills.hint"),scope:"world",config:!0,default:!1,type:Boolean,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"chatToTarget",{name:Utils.i18n("settings.chatToTarget.name"),hint:Utils.i18n("settings.chatToTarget.hint"),scope:"world",config:!0,type:String,default:"alwaysEveryone",choices:{alwaysEveryone:Utils.i18n("settings.chatToTarget.choices.alwaysEveryone"),alwaysUser:Utils.i18n("settings.chatToTarget.choices.alwaysUser"),shiftEveryoneElseUser:Utils.i18n("settings.chatToTarget.choices.shiftEveryoneElseUser"),shiftUserElseEveryone:Utils.i18n("settings.chatToTarget.choices.shiftUserElseEveryone")},onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"defaultAction",{name:Utils.i18n("settings.defaultAction.name"),hint:Utils.i18n("settings.defaultAction.hint"),scope:"world",config:!0,type:String,default:"requestRoll",choices:{nothing:Utils.i18n("settings.actionChoices.nothing"),requestRoll:Utils.i18n("settings.actionChoices.requestRoll"),requestRollDialog:Utils.i18n("settings.actionChoices.requestRollDialog"),initiateRoll:Utils.i18n("settings.actionChoices.initiateRoll")},onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"ctrlAction",{name:Utils.i18n("settings.ctrlAction.name"),hint:Utils.i18n("settings.ctrlAction.hint"),scope:"world",config:!0,type:String,default:"nothing",choices:{nothing:Utils.i18n("settings.actionChoices.nothing"),requestRoll:Utils.i18n("settings.actionChoices.requestRoll"),requestRollDialog:Utils.i18n("settings.actionChoices.requestRollDialog"),initiateRoll:Utils.i18n("settings.actionChoices.initiateRoll")},onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"altAction",{name:Utils.i18n("settings.altAction.name"),hint:Utils.i18n("settings.altAction.hint"),scope:"world",config:!0,type:String,default:"nothing",choices:{nothing:Utils.i18n("settings.actionChoices.nothing"),requestRoll:Utils.i18n("settings.actionChoices.requestRoll"),requestRollDialog:Utils.i18n("settings.actionChoices.requestRollDialog"),initiateRoll:Utils.i18n("settings.actionChoices.initiateRoll")},onChange:e=>{onChangeFunction()}}),Logger.debug("Settings Registered")};Hooks.on("ready",(async()=>{Hooks.callAll(e.LCCNAME+"Initialized"),Logger.info("Ready")})),Hooks.once("init",(()=>{registerSettings(),Logger.debug("Init Done")})),Hooks.on("canvasReady",(async()=>{Hooks.on(e.LCCNAME+"Initialized",(async()=>{const e=Utils.getSetting("gmOnly");game.gmTokenTools||(game.gmTokenTools=new GmTokenToolsApi,await game.gmTokenTools.init(),Logger.debug("gmTokenTools API registered as game.gmTokenTools")),game.user.isGM?Hooks.on("renderTokenHUD",((e,t,a)=>{game.gmTokenTools.gmTokenTools.addTokenInfos(e,t,a),game.gmTokenTools.gmTokenTools.addTokenActions(e,t,a)})):e||Hooks.on("renderTokenHUD",((e,t,a)=>{game.gmTokenTools.gmTokenTools.addTokenInfos(e,t,a)})),Hooks.on("updateToken",((e,t,a)=>{Object.hasOwn(a,"y")||Object.hasOwn("diff","x")||Logger.debug(updateToken)}))}))}));export{GmTokenTools,GmTokenToolsApi,Logger,e as MODULE,Utils,registerSettings};
